CREATE DATABASE actividad1;

\c actividad1

CREATE TABLE PERSONAS1 (
    RUT BIGINT,
    Nombre VARCHAR(50),
    Edad SMALLINT CHECK (Edad >= 0 AND Edad <= 99),
    Direccion VARCHAR(100)
);

COPY PERSONAS1 (RUT, Nombre, Edad, Direccion)
FROM '/home/kutty/Descargas/diezmil_sin_espacios.csv'
DELIMITER '|';  ---> SE USÒ FUNCIÒN SED PARA QUITAR ESPACIOS DEL ARCHIVO 'DIEZMIL'

\timing on                      
SELECT COUNT(*) FROM PERSONAS1;

\timing                      
SELECT COUNT(*) FROM PERSONAS1; 

CREATE INDEX personas1_rut_index ON PERSONAS1 (RUT);
Time: 71,263 ms ---- Time: 24,017 ms


CREATE TABLE PERSONAS2 (
    RUT BIGINT PRIMARY KEY,
    Nombre VARCHAR(50),
    Edad SMALLINT,
    Direccion VARCHAR(100)
);

COPY PERSONAS2 (RUT, Nombre, Edad, Direccion)
FROM '/home/kutty/Descargas/diezmil_sin_espacios.csv'
DELIMITER '|';
ERROR:  duplicate key value violates unique constraint "personas2_pkey"
DETAIL:  Key (rut)=(6551137333) already exists.
CONTEXT:  COPY personas2, line 3888

CREATE TEMP TABLE temp_personas2 (
    RUT BIGINT,
    Nombre VARCHAR(50),
    Edad SMALLINT,
    Direccion VARCHAR(100)
);     ------->SE CREA TABLA TEMPORAL

COPY temp_personas2 (RUT, Nombre, Edad, Direccion)
FROM '/home/kutty/Descargas/diezmil_sin_espacios.csv'
DELIMITER '|';    ----->INSERTAMOS EL ARCHIVO

INSERT INTO PERSONAS2 (RUT, Nombre, Edad, Direccion)
SELECT DISTINCT ON (RUT) RUT, Nombre, Edad, Direccion
FROM temp_personas2
ON CONFLICT DO NOTHING;  ------->VOLVEMOS A INSERTAR EN PERSONAS2 LOS DATOS UNICOS

DROP TABLE temp_personas2;

ALTER TABLE PERSONAS1 RENAME TO temp_personas1;
CREATE TEMP TABLE PERSONAS1 (
    RUT bigint,
    Nombre varchar(50),
    Edad smallint,
    Direccion varchar(100)
);

CREATE INDEX personas1_rut_index ON PERSONAS1 (RUT);

INSERT INTO PERSONAS1 (RUT, Nombre, Edad, Direccion)
SELECT DISTINCT ON (RUT) RUT, Nombre, Edad, Direccion
FROM temp_personas1
ON CONFLICT DO NOTHING; 

DROP TABLE temp_personas1;

-------------------------------------------------------------------
sort -u diezmil_sin_espacios.cvs > diezmil_sin_duplicados.csv



\q

mv /home/richard/Escritorio/diezmil /tmp/    --// SE MUEVE A TMP YA QUE ESTA CARPETA TIENE LOS PERMISOS ADECUADOS 

COPY PERSONAS1 (RUT, Nombre, Edad, Direccion) FROM '/tmp/diezmil' DELIMITER '|';

-rwxr-xr-x 1 postgres postgres 1714900 mar 14 17:55 diezmil


chmod +r /home/richard/Escritorio/act1/diezmil


